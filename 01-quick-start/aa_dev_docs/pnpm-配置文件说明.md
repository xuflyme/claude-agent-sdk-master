# pnpm é…ç½®æ–‡ä»¶è¯´æ˜æ–‡æ¡£

æœ¬æ–‡æ¡£æ•´ç†äº†é¡¹ç›®ä¸­ pnpm ç›¸å…³é…ç½®æ–‡ä»¶çš„ä½œç”¨å’Œä½¿ç”¨è¯´æ˜ã€‚

---

## ğŸ“‹ ç›®å½•

- [`.npmrc` é…ç½®æ–‡ä»¶](#npmrc-é…ç½®æ–‡ä»¶)
- [`pnpm-lock.yaml` é”å®šæ–‡ä»¶](#pnpm-lockyaml-é”å®šæ–‡ä»¶)
- [é…ç½®æ–‡ä»¶åä½œå…³ç³»](#é…ç½®æ–‡ä»¶åä½œå…³ç³»)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## `.npmrc` é…ç½®æ–‡ä»¶

### ğŸ¯ æ–‡ä»¶ä½œç”¨

`.npmrc` æ˜¯ **pnpm åŒ…ç®¡ç†å™¨çš„é…ç½®æ–‡ä»¶**ï¼Œç”¨äºå®šä¹‰é¡¹ç›®çš„ä¾èµ–å®‰è£…ç­–ç•¥å’Œè¡Œä¸ºã€‚

### ğŸ“ é…ç½®é¡¹è¯´æ˜

é¡¹ç›®ä¸­çš„é…ç½®å†…å®¹åŠå…¶å«ä¹‰ï¼š

#### `shamefully-hoist=true`
- **ä½œç”¨**ï¼šå°†æ‰€æœ‰ä¾èµ–æå‡åˆ°æ ¹ç›®å½•çš„ `node_modules`
- **ç”¨é€”**ï¼šæœ‰åŠ©äº Next.js çš„å…¼å®¹æ€§ï¼Œé¿å…æ¨¡å—è§£æé—®é¢˜
- **é€‚ç”¨åœºæ™¯**ï¼šNext.jsã€Webpack ç­‰å¯¹ä¾èµ–ç»“æ„æ•æ„Ÿçš„æ¡†æ¶

#### `auto-install-peers=true`
- **ä½œç”¨**ï¼šè‡ªåŠ¨å®‰è£… peer dependenciesï¼ˆå¯¹ç­‰ä¾èµ–ï¼‰
- **ç”¨é€”**ï¼šç®€åŒ–ä¾èµ–å®‰è£…æµç¨‹ï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£…å¯¹ç­‰ä¾èµ–
- **å¥½å¤„**ï¼šå‡å°‘å®‰è£…é”™è¯¯ï¼Œæå‡å¼€å‘ä½“éªŒ

#### `strict-peer-dependencies=false`
- **ä½œç”¨**ï¼šä¸ä¼šå› ä¸º peer dependency è­¦å‘Šè€Œå¯¼è‡´å®‰è£…å¤±è´¥
- **ç”¨é€”**ï¼šæ›´é€‚åˆæ•™ç¨‹ç¯å¢ƒï¼Œé¿å…ç‰ˆæœ¬å†²çªå½±å“å­¦ä¹ 
- **æƒè¡¡**ï¼šç”Ÿäº§ç¯å¢ƒå¯è€ƒè™‘è®¾ä¸º `true` ä»¥ç¡®ä¿ä¾èµ–ä¸¥æ ¼åŒ¹é…

#### `node-linker=hoisted`
- **ä½œç”¨**ï¼šä½¿ç”¨æå‡çš„ node_modules é“¾æ¥å™¨
- **ç”¨é€”**ï¼šä¸ Next.js ç­‰æ¡†æ¶æ›´å…¼å®¹
- **è¯´æ˜**ï¼šé…åˆ `shamefully-hoist` ä½¿ç”¨ï¼Œç¡®ä¿ä¾èµ–æ‰å¹³åŒ–

#### `save-exact=true`
- **ä½œç”¨**ï¼šå®‰è£…ä¾èµ–æ—¶ä¿å­˜ç²¾ç¡®ç‰ˆæœ¬å·ï¼ˆä½¿ç”¨ `=` è€Œä¸æ˜¯ `^` æˆ– `~`ï¼‰
- **ç”¨é€”**ï¼š**ç¡®ä¿æ‰€æœ‰å­¦ä¹ è€…å®‰è£…çš„ä¾èµ–ç‰ˆæœ¬å®Œå…¨ä¸€è‡´**
- **å¥½å¤„**ï¼šé¿å…"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘"çš„é—®é¢˜ï¼Œæ•™ç¨‹ç¯å¢ƒå¼ºçƒˆæ¨è

#### `# optional=false` (å·²æ³¨é‡Š)
- **ä½œç”¨**ï¼šè·³è¿‡å¯é€‰ä¾èµ–ä»¥åŠ å¿«å®‰è£…é€Ÿåº¦
- **çŠ¶æ€**ï¼šå½“å‰å·²æ³¨é‡Šæ‰ï¼Œæ ¹æ®éœ€è¦å¯ç”¨

### ğŸ”§ ä½¿ç”¨åœºæ™¯

è¿™ä¸ªæ–‡ä»¶ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè¢«è‡ªåŠ¨ä½¿ç”¨ï¼š

#### 1. æ‰§è¡Œ pnpm å‘½ä»¤æ—¶
```bash
pnpm install          # å®‰è£…æ‰€æœ‰ä¾èµ–
pnpm add <package>    # æ·»åŠ æ–°ä¾èµ–
pnpm update           # æ›´æ–°ä¾èµ–
pnpm remove <package> # ç§»é™¤ä¾èµ–
```

#### 2. é¡¹ç›®ä½ç½®
- ä½äºé¡¹ç›®æ ¹ç›®å½•
- pnpm ä¼šè‡ªåŠ¨è¯»å–å¹¶åº”ç”¨è¿™äº›é…ç½®
- **æ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œå¼€ç®±å³ç”¨**

#### 3. ä½œç”¨èŒƒå›´
- å½±å“æ•´ä¸ªé¡¹ç›®ï¼ˆåŒ…æ‹¬ monorepo ä¸­çš„æ‰€æœ‰å·¥ä½œç©ºé—´ï¼‰
- åœ¨é¡¹ç›®æ ¹ç›®å½•æˆ–ä»»ä½•å­ç›®å½•æ‰§è¡Œ pnpm å‘½ä»¤æ—¶éƒ½ä¼šç”Ÿæ•ˆ

### ğŸ“ åœ¨æœ¬æ•™ç¨‹é¡¹ç›®ä¸­çš„é‡è¦æ€§

æœ¬é¡¹ç›®æ˜¯ **Claude Agent SDK Master** æ•™ç¨‹ç³»åˆ—ï¼Œ`.npmrc` çš„é…ç½®å¯¹æ•™ç¨‹è‡³å…³é‡è¦ï¼š

#### 1. Monorepo å·¥ä½œç©ºé—´æ”¯æŒ
- é¡¹ç›®ä½¿ç”¨ `pnpm-workspace.yaml` å®šä¹‰äº† monorepo ç»“æ„ï¼ˆ`packages/*`ï¼‰
- `shamefully-hoist=true` å’Œ `node-linker=hoisted` ç¡®ä¿æ‰€æœ‰åŒ…çš„ä¾èµ–éƒ½æå‡åˆ°æ ¹ç›®å½•
- é¿å… Next.js åœ¨ monorepo ç¯å¢ƒä¸­æ‰¾ä¸åˆ°æ¨¡å—

#### 2. æ•™ç¨‹ä¸€è‡´æ€§ä¿è¯
- `save-exact=true` **ç¡®ä¿æ‰€æœ‰å­¦ä¹ è€…å®‰è£…çš„ä¾èµ–ç‰ˆæœ¬å®Œå…¨ä¸€è‡´**
- é¿å…ç‰ˆæœ¬å·®å¼‚å¯¼è‡´çš„é—®é¢˜
- æä¾›å¯é çš„å­¦ä¹ ç¯å¢ƒ

#### 3. Next.js å…¼å®¹æ€§ä¼˜åŒ–
- Next.js å¯¹ä¾èµ–ç»“æ„æ¯”è¾ƒæ•æ„Ÿ
- hoisted æ¨¡å¼èƒ½é¿å…æ¨¡å—è§£æé—®é¢˜
- è¿™å¯¹äº `01-quick-start` ç­‰ Next.js æ•™ç¨‹é¡¹ç›®å°¤å…¶é‡è¦

---

## `pnpm-lock.yaml` é”å®šæ–‡ä»¶

### ğŸ¯ æ–‡ä»¶ä½œç”¨

`pnpm-lock.yaml` æ˜¯ **pnpm çš„ä¾èµ–é”å®šæ–‡ä»¶**ï¼Œç±»ä¼¼äºï¼š
- npm çš„ `package-lock.json`
- yarn çš„ `yarn.lock`

### ğŸ”’ æ ¸å¿ƒåŠŸèƒ½

#### 1. é”å®šä¾èµ–ç‰ˆæœ¬
- è®°å½•é¡¹ç›®ä¸­æ‰€æœ‰ä¾èµ–åŒ…ï¼ˆåŒ…æ‹¬é—´æ¥ä¾èµ–ï¼‰çš„**ç²¾ç¡®ç‰ˆæœ¬å·**
- ç¡®ä¿æ¯æ¬¡å®‰è£…éƒ½å¾—åˆ°å®Œå…¨ç›¸åŒçš„ä¾èµ–æ ‘
- åŒ…å«ä¾èµ–çš„å®Œæ•´æ€§æ ¡éªŒå“ˆå¸Œå€¼

#### 2. ä¿è¯ä¸€è‡´æ€§
- âœ… ä¸åŒå¼€å‘è€…åœ¨ä¸åŒæœºå™¨ä¸Šè¿è¡Œ `pnpm install` ä¼šå®‰è£…**å®Œå…¨ç›¸åŒç‰ˆæœ¬**çš„ä¾èµ–
- âœ… CI/CD ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒéƒ½èƒ½å¤ç°ç›¸åŒçš„ä¾èµ–ç»“æ„
- âœ… é¿å…"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘"çš„é—®é¢˜

#### 3. è®°å½•ä¾èµ–å…³ç³»
å®Œæ•´è®°å½•ï¼š
- æ¯ä¸ªåŒ…çš„ç¡®åˆ‡ç‰ˆæœ¬
- åŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»
- åŒ…çš„ä¸‹è½½åœ°å€ï¼ˆregistryï¼‰
- å®Œæ•´æ€§æ ¡éªŒå“ˆå¸Œå€¼ï¼ˆintegrity hashï¼‰

#### 4. æå‡å®‰è£…é€Ÿåº¦
- pnpm å¯ä»¥æ ¹æ® lock æ–‡ä»¶ç›´æ¥ä¸‹è½½å¯¹åº”ç‰ˆæœ¬
- æ— éœ€é‡æ–°è§£æä¾èµ–å…³ç³»
- æ˜¾è‘—æå‡å®‰è£…æ•ˆç‡

### ğŸ“¦ æ–‡ä»¶ç»“æ„è¯´æ˜

æœ¬é¡¹ç›®çš„ `pnpm-lock.yaml` æ–‡ä»¶åŒ…å«çº¦ 6000+ è¡Œï¼Œç»“æ„å¦‚ä¸‹ï¼š

#### 1. å…ƒæ•°æ®éƒ¨åˆ†ï¼ˆæ–‡ä»¶å¼€å¤´ï¼‰
```yaml
lockfileVersion: '9.0'

settings:
  autoInstallPeers: true
  excludeLinksFromLockfile: false
```
- é”å®šæ–‡ä»¶æ ¼å¼ç‰ˆæœ¬
- ç»§æ‰¿ `.npmrc` çš„é…ç½®

#### 2. importers éƒ¨åˆ†
```yaml
importers:
  .:  # æ ¹ç›®å½•é¡¹ç›®
    dependencies:
      next:
        specifier: 16.1.6           # package.json ä¸­å£°æ˜çš„ç‰ˆæœ¬
        version: 16.1.6(...)        # å®é™…å®‰è£…çš„ç‰ˆæœ¬åŠå…¶ä¾èµ–

  packages/core:  # monorepo å­åŒ…
    dependencies:
      '@anthropic-ai/claude-agent-sdk':
        specifier: ^0.1.0
        version: 0.1.77(zod@4.3.6)
```
**è¯´æ˜**ï¼šè®°å½•æ¯ä¸ªå·¥ä½œç©ºé—´ï¼ˆworkspaceï¼‰çš„ç›´æ¥ä¾èµ–

#### 3. packages éƒ¨åˆ†ï¼ˆæ–‡ä»¶ä¸»ä½“ï¼Œ6000+ è¡Œï¼‰
```yaml
packages:
  '@anthropic-ai/claude-agent-sdk@0.1.77':
    resolution: {integrity: sha512-ZEjWQtkoB2M...}
    engines: {node: '>=18.0.0'}
    peerDependencies:
      zod: ^3.25.0 || ^4.0.0
      
  '@babel/core@7.28.6':
    resolution: {integrity: sha512-H3mcG6ZDLTlYfaSN...}
    engines: {node: '>=6.9.0'}
```
**è¯´æ˜**ï¼šè®°å½•æ‰€æœ‰ä¾èµ–åŒ…ï¼ˆåŒ…æ‹¬é—´æ¥ä¾èµ–ï¼‰çš„è¯¦ç»†ä¿¡æ¯

### ğŸ”„ å·¥ä½œæµç¨‹ç¤ºä¾‹

#### å¼€å‘è€… A æ·»åŠ æ–°ä¾èµ–
```bash
pnpm add react-query
# â†’ pnpm-lock.yaml è‡ªåŠ¨æ›´æ–°
# â†’ package.json ä¹Ÿä¼šæ›´æ–°

git add package.json pnpm-lock.yaml
git commit -m "feat: add react-query"
git push
```

#### å¼€å‘è€… B æ‹‰å–ä»£ç 
```bash
git pull
pnpm install
# â†’ æ ¹æ® lock æ–‡ä»¶å®‰è£…
# â†’ å¾—åˆ°å’Œ A å®Œå…¨ç›¸åŒçš„ä¾èµ–ç‰ˆæœ¬ âœ…
```

---

## é…ç½®æ–‡ä»¶åä½œå…³ç³»

### ğŸ“‹ ä¸‰ä¸ªæ–‡ä»¶çš„åˆ†å·¥

| æ–‡ä»¶ | ä½œç”¨ | æ˜¯å¦æäº¤åˆ° Git |
|------|------|----------------|
| **`.npmrc`** | å®šä¹‰**å®‰è£…ç­–ç•¥**ï¼ˆå¦‚ä½•å®‰è£…ï¼‰ | âœ… æäº¤ |
| **`pnpm-lock.yaml`** | è®°å½•**å®‰è£…ç»“æœ**ï¼ˆå®‰è£…äº†ä»€ä¹ˆï¼‰ | âœ… æäº¤ |
| **`package.json`** | å£°æ˜**ä¾èµ–éœ€æ±‚**ï¼ˆéœ€è¦ä»€ä¹ˆï¼‰ | âœ… æäº¤ |

### ğŸ”„ åä½œæµç¨‹

```
package.json          .npmrc              pnpm-lock.yaml
ï¼ˆéœ€è¦ä»€ä¹ˆï¼‰    +    ï¼ˆå¦‚ä½•å®‰è£…ï¼‰   â†’    ï¼ˆå®‰è£…äº†ä»€ä¹ˆï¼‰
     â†“                   â†“                      â†“
å£°æ˜ä¾èµ–ç‰ˆæœ¬èŒƒå›´    å®šä¹‰å®‰è£…è¡Œä¸º          é”å®šç²¾ç¡®ç‰ˆæœ¬
```

### ğŸ“ å®é™…ä¾‹å­

#### `package.json` å£°æ˜
```json
{
  "dependencies": {
    "next": "16.1.6",
    "react": "^19.2.0"
  }
}
```

#### `.npmrc` å®šä¹‰ç­–ç•¥
```ini
save-exact=true
shamefully-hoist=true
```

#### `pnpm-lock.yaml` è®°å½•ç»“æœ
```yaml
importers:
  .:
    dependencies:
      next:
        specifier: 16.1.6
        version: 16.1.6(@babel/core@7.28.6)(react-dom@19.2.3)(react@19.2.3)
      react:
        specifier: ^19.2.0
        version: 19.2.3
```

---

## æœ€ä½³å®è·µ

### âœ… åº”è¯¥åšçš„

#### 1. æäº¤æ‰€æœ‰é…ç½®æ–‡ä»¶åˆ° Git
```bash
git add .npmrc package.json pnpm-lock.yaml
git commit -m "chore: update dependencies"
```
**åŸå› **ï¼šç¡®ä¿æ‰€æœ‰åä½œè€…éƒ½èƒ½è·å¾—ç›¸åŒçš„é…ç½®å’Œä¾èµ–

#### 2. ä¸è¦æ‰‹åŠ¨ç¼–è¾‘ `pnpm-lock.yaml`
- è®© pnpm è‡ªåŠ¨ç»´æŠ¤è¿™ä¸ªæ–‡ä»¶
- æ‰‹åŠ¨ç¼–è¾‘å®¹æ˜“å‡ºé”™ä¸”ä¼šè¢«è¦†ç›–

#### 3. ä¾èµ–æ›´æ–°åæäº¤å˜æ›´
```bash
pnpm add <package>           # è‡ªåŠ¨æ›´æ–° lock æ–‡ä»¶
git add package.json pnpm-lock.yaml
git commit -m "feat: add <package>"
```

#### 4. æ–°æˆå‘˜åŠ å…¥é¡¹ç›®æ—¶
```bash
git clone <repository>
cd <project>
pnpm install                 # æ ¹æ® lock æ–‡ä»¶å®‰è£…ä¾èµ–
```

#### 5. å®šæœŸæ›´æ–°ä¾èµ–ï¼ˆå¯é€‰ï¼‰
```bash
pnpm update                  # æ›´æ–°ä¾èµ–åˆ°å…è®¸çš„æœ€æ–°ç‰ˆæœ¬
git add pnpm-lock.yaml
git commit -m "chore: update dependencies"
```

### âŒ ä¸åº”è¯¥åšçš„

#### 1. ~~åˆ é™¤ lock æ–‡ä»¶~~
- âŒ ä¼šå¯¼è‡´ç‰ˆæœ¬ä¸ä¸€è‡´
- âŒ å¤±å»ç‰ˆæœ¬é”å®šçš„ä¿æŠ¤

#### 2. ~~æ·»åŠ åˆ° `.gitignore`~~
- âŒ å›¢é˜Ÿåä½œå¿…éœ€
- âŒ CI/CD ç¯å¢ƒéœ€è¦

#### 3. ~~æ‰‹åŠ¨ä¿®æ”¹ lock æ–‡ä»¶å†…å®¹~~
- âŒ å®¹æ˜“å‡ºé”™
- âŒ ä¼šè¢« pnpm è¦†ç›–

#### 4. ~~æ··ç”¨åŒ…ç®¡ç†å™¨~~
```bash
# âŒ ä¸è¦è¿™æ ·åš
npm install    # ä¼šç”Ÿæˆ package-lock.json
yarn add       # ä¼šç”Ÿæˆ yarn.lock
pnpm add       # ä¼šç”Ÿæˆ pnpm-lock.yaml
```
**åŸå› **ï¼šä¼šäº§ç”Ÿå¤šä¸ª lock æ–‡ä»¶ï¼Œå¯¼è‡´ä¾èµ–å†²çª

### ğŸ”§ æ•…éšœæ’é™¤

#### é—®é¢˜ï¼šä¾èµ–å®‰è£…å¤±è´¥
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ¸…ç†ç¼“å­˜åé‡æ–°å®‰è£…
rm -rf node_modules
pnpm store prune
pnpm install
```

#### é—®é¢˜ï¼šlock æ–‡ä»¶å†²çªï¼ˆGit merge æ—¶ï¼‰
```bash
# è§£å†³æ–¹æ¡ˆï¼šåˆ é™¤ lock æ–‡ä»¶åé‡æ–°ç”Ÿæˆ
rm pnpm-lock.yaml
pnpm install
git add pnpm-lock.yaml
```

#### é—®é¢˜ï¼šmonorepo ä¸­æŸä¸ªåŒ…æ‰¾ä¸åˆ°ä¾èµ–
```bash
# ç¡®ä¿ .npmrc ä¸­æœ‰ä»¥ä¸‹é…ç½®
shamefully-hoist=true
node-linker=hoisted

# é‡æ–°å®‰è£…
rm -rf node_modules
pnpm install
```

---

## ğŸ“š ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [pnpm å®˜æ–¹æ–‡æ¡£](https://pnpm.io/)
- [pnpm é…ç½®æ–‡ä»¶](https://pnpm.io/npmrc)
- [pnpm Workspaces](https://pnpm.io/workspaces)

### é¡¹ç›®æ–‡æ¡£
- [Claude Agent SDK Master README](../README.md)
- [ç¬¬ä¸€ç« æ•™ç¨‹](../README.md)
- [CLAUDE.md å¼€å‘æŒ‡å¼•](../CLAUDE.md)

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **`.npmrc`**ï¼šå®šä¹‰å®‰è£…ç­–ç•¥ï¼Œé…ç½® pnpm è¡Œä¸º
2. **`pnpm-lock.yaml`**ï¼šé”å®šç²¾ç¡®ç‰ˆæœ¬ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´
3. **ä¸¤è€…é…åˆ**ï¼šæä¾›å¯é ã€ä¸€è‡´çš„å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒ

### å¯¹æ•™ç¨‹é¡¹ç›®çš„ä»·å€¼

- âœ… ç¡®ä¿æ‰€æœ‰å­¦ä¹ è€…æœ‰**å®Œå…¨ç›¸åŒçš„å¼€å‘ç¯å¢ƒ**
- âœ… é¿å…ç‰ˆæœ¬å·®å¼‚å¯¼è‡´çš„é—®é¢˜
- âœ… æ”¯æŒ monorepo æ¶æ„å’Œ Next.js å…¼å®¹æ€§
- âœ… æä¾›ä¸“ä¸šçš„é¡¹ç›®é…ç½®ç¤ºèŒƒ

### è®°ä½

> **è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ•™ç¨‹é¡¹ç›®èƒ½ç¡®ä¿æ‰€æœ‰å­¦ä¹ è€…éƒ½æœ‰ä¸€è‡´çš„å¼€å‘ç¯å¢ƒï¼** ğŸ¯

---

*æœ¬æ–‡æ¡£åŸºäºé¡¹ç›®å®é™…é…ç½®æ•´ç†è€Œæˆ*  
*æœ€åæ›´æ–°ï¼š2026-02-02*
